const iframe = Addon.iframe();

const innInput = document.getElementById('innInput');
const checkButton = document.getElementById('check');
const cancelButton = document.getElementById('cancel');
const loader = document.getElementById('loader');
const buttons = document.getElementById('buttons');
const results = document.getElementById('results');
const checkLinks = document.getElementById('checkLinks');
const classifiedCheck = document.getElementById('classifiedCheck');
const tourOperatorCheck = document.getElementById('tourOperatorCheck');
const agentLinkInput = document.getElementById('agentLinkInput');
const completeCheckButton = document.getElementById('completeCheck');

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–ø–∞–Ω–∏–∏
let companyData = null;

iframe.fitSize('#checkInnContent');

function setLoading(isLoading) {
 loader.style.display = isLoading ? 'block' : 'none';
 checkButton.disabled = isLoading;
 innInput.disabled = isLoading;
 iframe.fitSize('#checkInnContent');
}

function formatDateTime() {
 const now = new Date();
 return new Intl.DateTimeFormat('ru-RU', {
   day: '2-digit',
   month: '2-digit',
   year: 'numeric',
   hour: '2-digit',
   minute: '2-digit',
   timeZone: 'Europe/Moscow'
 }).format(now);
}

function renderResults(data) {
 companyData = data;
 results.style.display = 'block';
 results.innerHTML = `
   <div class="company-info">
     <span style="font-size: 14px; color: var(--addon-text-secondary-color);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:</span>
     <div style="font-size: 16px; font-weight: 500; margin: 4px 0 16px 0; color: var(--addon-text-primary-color);">
       ${data.title || '-'}
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; background: var(--addon-background-level2); border-radius: 8px;">
       <div style="color: var(--addon-text-primary-color);">
         <div style="margin-bottom: 8px;">
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–ò–ù–ù</div>
           <div style="font-weight: 500;">${data.inn || '-'}</div>
         </div>
         <div style="margin-bottom: 8px;">
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–ö–ü–ü</div>
           <div style="font-weight: 500;">${data.kpp || '-'}</div>
         </div>
         <div>
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–û–ì–†–ù</div>
           <div style="font-weight: 500;">${data.ogrn || '-'}</div>
         </div>
       </div>
       <div style="color: var(--addon-text-primary-color);">
         <div style="margin-bottom: 8px;">
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–°—Ç–∞—Ç—É—Å</div>
           <div style="font-weight: 500;">${data.status || '-'}</div>
         </div>
         <div style="margin-bottom: 8px;">
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–û–ö–ü–û</div>
           <div style="font-weight: 500;">${data.okpo || '-'}</div>
         </div>
         <div>
           <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–û–ö–í–≠–î</div>
           <div style="font-weight: 500;">${data.okved || '-'}</div>
         </div>
       </div>
     </div>
     <div style="margin-top: 12px;">
       <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–ê–¥—Ä–µ—Å</div>
       <div style="margin-top: 4px; color: var(--addon-text-primary-color);">${data.address || '-'}</div>
     </div>
     <div style="margin-top: 12px;">
       <div style="color: var(--addon-text-secondary-color); font-size: 12px;">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</div>
       <div style="margin-top: 4px; color: var(--addon-text-primary-color);">${data.managementFIO || '-'}</div>
       <div style="font-size: 12px; color: var(--addon-text-secondary-color); margin-top: 2px;">${data.managementPost || '-'}</div>
     </div>
   </div>
 `;
 checkLinks.style.display = 'block';
 iframe.fitSize('#checkInnContent');
}

cancelButton.addEventListener('click', () => {
 iframe.closePopup();
});

checkButton.addEventListener('click', async () => {
 const inn = innInput.value.trim();
 
 if (!inn || inn.length < 10) {
   iframe.showSnackbar('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò–ù–ù', 'warning');
   return;
 }

 try {
   results.style.display = 'none';
   checkLinks.style.display = 'none';
   setLoading(true);
   
   const response = await fetch(`https://mt.mosgortur.ru/MGTAPI/api/PartnerRequisites/${inn}`);
   
   if (!response.ok) {
     throw new Error(`HTTP error! status: ${response.status}`);
   }
   
   const data = await response.json();

   if (data.error) {
     setLoading(false);
     iframe.showSnackbar(`–û—à–∏–±–∫–∞: ${data.error}`, 'error');
     return;
   }

   setLoading(false);
   renderResults(data);

 } catch (error) {
   console.error('Error details:', error);
   iframe.showSnackbar('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ò–ù–ù. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'error');
   setLoading(false);
 }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫
document.querySelector('a[href*="fsa.gov.ru"]').addEventListener('click', () => {
 classifiedCheck.style.display = 'inline';
});

document.querySelector('a[href*="economy.gov.ru"]').addEventListener('click', () => {
 tourOperatorCheck.style.display = 'inline';
});

document.querySelector('a[href*="tourism.gov.ru"]').addEventListener('click', () => {
 agentLinkInput.style.display = 'block';
 iframe.fitSize('#checkInnContent');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
completeCheckButton.addEventListener('click', async () => {
 if (!companyData) {
   iframe.showSnackbar('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–ø–∞–Ω–∏–∏', 'error');
   return;
 }

 try {
   // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
   let checkResult = `\n\n### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –æ—Ç ${formatDateTime()} (–ú–°–ö)\n\n`;
   checkResult += `**–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:** ${companyData.title}\n`;
   checkResult += `**–ò–ù–ù:** ${companyData.inn}\n`;
   checkResult += `**–ö–ü–ü:** ${companyData.kpp}\n`;
   checkResult += `**–û–ì–†–ù:** ${companyData.ogrn}\n`;
   checkResult += `**–°—Ç–∞—Ç—É—Å:** ${companyData.status}\n`;
   checkResult += `**–ê–¥—Ä–µ—Å:** ${companyData.address}\n`;
   checkResult += `**–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:** ${companyData.managementFIO}\n`;
   checkResult += `**–î–æ–ª–∂–Ω–æ—Å—Ç—å:** ${companyData.managementPost}\n\n`;
   
   if (classifiedCheck.style.display === 'inline') {
     checkResult += '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω –≤ –†–µ–µ—Å—Ç—Ä–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤\n';
   }
   
   if (tourOperatorCheck.style.display === 'inline') {
     checkResult += '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω –≤ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–º —Ä–µ–µ—Å—Ç—Ä–µ –¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤\n';
   }
   
   const agentLinkValue = agentLinkInput.querySelector('input')?.value;
   if (agentLinkValue) {
     checkResult += `üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–µ—Å—Ç—Ä –¢—É—Ä–∞–≥–µ–Ω—Ç–æ–≤: ${agentLinkValue}\n`;
   }

   // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
   const card = await iframe.getCard();
   const currentDescription = card.description || '';
   const newDescription = currentDescription + checkResult;

   await iframe.updateCard({ description: newDescription });
   
   iframe.showSnackbar('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏', 'success');
   iframe.closePopup();

 } catch (error) {
   console.error('Error updating card:', error);
   iframe.showSnackbar('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏', 'error');
 }
});

innInput.addEventListener('keypress', (e) => {
 if (e.key === 'Enter' && !innInput.disabled) {
   checkButton.click();
 }
});